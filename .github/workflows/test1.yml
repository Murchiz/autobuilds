name: Build Corretto 21 lilliput-2 for Windows (Gradle)

on:
  schedule:
    - cron: '0 5 * * 1'
  workflow_dispatch:

env:
  UPSTREAM_REPO: corretto/corretto-21
  UPSTREAM_BRANCH: lilliput-2
  GITHUB_VARIABLE_NAME: LAST_BUILT_CORRETTO_LILLIPUT_SHA
  CORRETTO_SOURCE_DIR: corretto_source_checkout
  NEW_GRADLE_VERSION: '8.5'

jobs:
  build_if_new_commits:
    runs-on: windows-latest
    permissions:
      contents: write
      actions: read
    steps:
      # Steps 1-5: No changes
      - name: Read Last Built Upstream SHA from GitHub Variable
        id: read_last_sha
        run: |
          $sha_from_var = "${{ vars[env.GITHUB_VARIABLE_NAME] || '' }}"
          echo "last_sha=$sha_from_var" >> $GITHUB_OUTPUT
        shell: pwsh

      - name: Checkout upstream repository
        id: checkout_upstream
        uses: actions/checkout@v4
        with:
          repository: ${{ env.UPSTREAM_REPO }}
          ref: ${{ env.UPSTREAM_BRANCH }}
          fetch-depth: 0
          path: ${{ env.CORRETTO_SOURCE_DIR }}

      - name: Get Current Upstream SHA
        id: get_upstream_sha
        working-directory: ${{ env.CORRETTO_SOURCE_DIR }}
        run: |
          $current_sha = (git rev-parse HEAD).Trim()
          echo "sha=$current_sha" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Determine if Build is Needed
        id: check_build_condition
        run: |
          $last_sha = "${{ steps.read_last_sha.outputs.last_sha }}"
          $current_sha = "${{ steps.get_upstream_sha.outputs.sha }}"
          $needs_build = "false"
          if ("${{ github.event_name }}" -eq "workflow_dispatch" -or $last_sha -ne $current_sha) {
            $needs_build = "true"
          }
          echo "needs_build=$needs_build" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Update GitHub Repository Variable with PAT
        if: steps.check_build_condition.outputs.needs_build == 'true'
        env:
          NEW_SHA_TO_SAVE: ${{ steps.get_upstream_sha.outputs.sha }}
          GH_TOKEN: ${{ secrets.MY_PAT }}
          TARGET_VARIABLE_NAME: ${{ env.GITHUB_VARIABLE_NAME }}
        run: |
          gh variable set "$TARGET_VARIABLE_NAME" --body "$NEW_SHA_TO_SAVE" --repo "${{ github.repository }}"
        shell: bash

      # 6. Set up the single JDK for both Gradle and the build
      - name: Set up Corretto JDK 21
        if: steps.check_build_condition.outputs.needs_build == 'true'
        id: setup_jdk
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: '21'
          architecture: x64

      # 7. Update the Gradle Wrapper to a version compatible with JDK 21
      - name: Update Gradle Wrapper to Version ${{ env.NEW_GRADLE_VERSION }}
        if: steps.check_build_condition.outputs.needs_build == 'true'
        working-directory: ${{ env.CORRETTO_SOURCE_DIR }}
        run: |
          $wrapperPropertiesPath = ".\gradle\wrapper\gradle-wrapper.properties"
          $newDistributionUrl = "https\://services.gradle.org/distributions/gradle-${{ env.NEW_GRADLE_VERSION }}-bin.zip"
          (Get-Content -Path $wrapperPropertiesPath -Raw) -replace "distributionUrl=.*", "distributionUrl=$newDistributionUrl" | Set-Content -Path $wrapperPropertiesPath
          Write-Host "Gradle Wrapper properties updated."
        shell: pwsh

      # 8. NEW: Fix the build script for the new Gradle version
      - name: Fix Deprecated Gradle APIs in build.gradle
        if: steps.check_build_condition.outputs.needs_build == 'true'
        working-directory: ${{ env.CORRETTO_SOURCE_DIR }}
        run: |
          $buildGradlePath = ".\build.gradle"
          Write-Host "Patching build.gradle for Gradle 8.5 compatibility..."
          (Get-Content -Path $buildGradlePath -Raw) -replace 'archiveName ', 'archiveFileName ' | Set-Content -Path $buildGradlePath
          Write-Host "build.gradle patched to use 'archiveFileName'."
        shell: pwsh

      # 9. Build with the upgraded Gradle and patched build script
      - name: Build Corretto JDK Image with Gradle
        if: steps.check_build_condition.outputs.needs_build == 'true'
        working-directory: ${{ env.CORRETTO_SOURCE_DIR }}
        run: ./gradlew.bat images --no-daemon
        shell: pwsh
        env:
          BOOT_JDK: ${{ steps.setup_jdk.outputs.path }}

      # Steps 10-12: No changes
      - name: Clean Debug Symbols from JDK Image
        if: steps.check_build_condition.outputs.needs_build == 'true'
        working-directory: ${{ env.CORRETTO_SOURCE_DIR }}
        run: |
          $jdkImagePath = Get-ChildItem -Path "corretto-build\**\images\jdk" -Directory -ErrorAction SilentlyContinue | Select-Object -First 1 -ExpandProperty FullName
          if ($jdkImagePath) {
            Write-Host "Cleaning *.pdb and *.map files from $jdkImagePath"
            Get-ChildItem -Path $jdkImagePath -Recurse -Include "*.pdb", "*.map" | Remove-Item -Force -ErrorAction SilentlyContinue
          } else {
            Write-Warning "Could not find JDK image directory to clean."
          }
        shell: pwsh

      - name: Prepare Artifact Structure
        if: steps.check_build_condition.outputs.needs_build == 'true'
        id: prepare_artifact
        working-directory: ${{ env.CORRETTO_SOURCE_DIR }}
        run: |
          $jdkSourcePath = Get-ChildItem -Path "corretto-build\**\images\jdk" -Directory -ErrorAction SilentlyContinue | Select-Object -First 1 -ExpandProperty FullName
          if (-not $jdkSourcePath) { Write-Error "Could not find source JDK image directory in 'corretto-build'."; exit 1 }
          $releaseFile = Join-Path $jdkSourcePath "release"
          if (-not (Test-Path $releaseFile)) { Write-Error "Could not find release file at $releaseFile"; exit 1 }
          $releaseContent = Get-Content $releaseFile | ForEach-Object { $parts = $_.Split('=', 2); if ($parts.Length -eq 2) { [pscustomobject]@{ Name = $parts[0]; Value = $parts[1].Trim('"') } } } | Where-Object { $_.Name -eq 'JAVA_VERSION' }
          $javaVersion = $releaseContent.Value
          if (-not $javaVersion) { Write-Error "Could not parse JAVA_VERSION from release file"; exit 1 }
          echo "JAVA_VERSION_EXTRACTED=$javaVersion" >> $GITHUB_OUTPUT
          $stagingDir = Join-Path $env:GITHUB_WORKSPACE "staging_artifact"
          $targetDirName = "corretto-21-lilliput-${javaVersion}"
          $fullTargetPathInStaging = Join-Path $stagingDir $targetDirName
          if (Test-Path $stagingDir) { Remove-Item -Recurse -Force $stagingDir }
          New-Item -ItemType Directory -Path $fullTargetPathInStaging | Out-Null
          Copy-Item -Path (Join-Path $jdkSourcePath "*") -Destination $fullTargetPathInStaging -Recurse -Force
        shell: pwsh

      - name: Upload Windows JDK Build Artifact
        if: steps.check_build_condition.outputs.needs_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: corretto-21-lilliput-${{ steps.prepare_artifact.outputs.JAVA_VERSION_EXTRACTED }}-windows-x64-jdk
          path: staging_artifact/
