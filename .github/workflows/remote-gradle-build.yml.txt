name: Remote Gradle Builder

on:
  workflow_dispatch:
    inputs:
      # Single or multiple repositories
      repositories:
        description: 'Repositories to build (comma-separated: owner/repo, owner2/repo2)'
        required: true
        type: string
        default: 'spring-projects/spring-petclinic'
      
      # Advanced: JSON config for per-repo settings
      advanced_config:
        description: 'Advanced JSON config (overrides other inputs if set)'
        required: false
        type: string
        default: ''
        # Example: [{"repo":"owner/repo","java":"17","tasks":"build"},{"repo":"owner2/repo2","java":"11","tasks":"assemble"}]
      
      ref:
        description: 'Branch/tag/SHA (applies to all repos unless using advanced_config)'
        required: false
        default: ''
        type: string
      
      java_version:
        description: 'Java version (applies to all repos)'
        required: false
        default: '17'
        type: choice
        options:
          - '8'
          - '11'
          - '17'
          - '21'
          - '22'
      
      java_distribution:
        description: 'Java distribution'
        required: false
        default: 'temurin'
        type: choice
        options:
          - temurin
          - zulu
          - corretto
          - liberica
          - microsoft
          - oracle
      
      gradle_tasks:
        description: 'Gradle tasks (applies to all repos)'
        required: false
        default: 'build'
        type: string
      
      gradle_args:
        description: 'Additional Gradle arguments'
        required: false
        default: '--no-daemon'
        type: string
      
      runner_os:
        description: 'Runner OS'
        required: false
        default: 'ubuntu-latest'
        type: choice
        options:
          - ubuntu-latest
          - ubuntu-22.04
          - windows-latest
          - macos-latest
          - macos-14
      
      max_parallel:
        description: 'Max parallel jobs'
        required: false
        default: '5'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '5'
          - '10'
          - '20'
      
      fail_fast:
        description: 'Fail fast (stop all on first failure)'
        required: false
        default: false
        type: boolean
      
      upload_artifacts:
        description: 'Upload build artifacts'
        required: false
        default: true
        type: boolean
      
      enable_build_scan:
        description: 'Enable Gradle Build Scan'
        required: false
        default: false
        type: boolean

env:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true"

jobs:
  # Parse inputs and create build matrix
  setup-matrix:
    name: ðŸ“‹ Setup Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.create-matrix.outputs.matrix }}
      repo_count: ${{ steps.create-matrix.outputs.repo_count }}
    
    steps:
      - name: Create build matrix
        id: create-matrix
        uses: actions/github-script@v7
        with:
          script: |
            const advancedConfig = `${{ inputs.advanced_config }}`.trim();
            const defaultJava = '${{ inputs.java_version }}';
            const defaultTasks = '${{ inputs.gradle_tasks }}';
            const defaultRef = '${{ inputs.ref }}';
            const defaultArgs = '${{ inputs.gradle_args }}';
            const runnerOs = '${{ inputs.runner_os }}';
            
            let builds = [];
            
            if (advancedConfig && advancedConfig !== '') {
              // Parse advanced JSON config
              try {
                const config = JSON.parse(advancedConfig);
                builds = config.map((item, index) => ({
                  index: index + 1,
                  repository: item.repo || item.repository,
                  ref: item.ref || item.branch || defaultRef || '',
                  java_version: String(item.java || item.java_version || defaultJava),
                  gradle_tasks: item.tasks || item.gradle_tasks || defaultTasks,
                  gradle_args: item.args || item.gradle_args || defaultArgs,
                  subproject: item.subproject || item.path || '',
                  runner: item.runner || item.os || runnerOs
                }));
              } catch (e) {
                core.setFailed(`Invalid JSON config: ${e.message}`);
                return;
              }
            } else {
              // Parse comma-separated repositories
              const repos = `${{ inputs.repositories }}`
                .split(',')
                .map(r => r.trim())
                .filter(r => r.length > 0);
              
              builds = repos.map((repo, index) => ({
                index: index + 1,
                repository: repo,
                ref: defaultRef,
                java_version: defaultJava,
                gradle_tasks: defaultTasks,
                gradle_args: defaultArgs,
                subproject: '',
                runner: runnerOs
              }));
            }
            
            if (builds.length === 0) {
              core.setFailed('No repositories specified');
              return;
            }
            
            // Validate repository format
            for (const build of builds) {
              if (!build.repository.match(/^[\w.-]+\/[\w.-]+$/)) {
                core.setFailed(`Invalid repository format: ${build.repository}. Expected: owner/repo`);
                return;
              }
            }
            
            console.log(`ðŸ“¦ Building ${builds.length} repositories:`);
            builds.forEach(b => console.log(`  - ${b.repository} (Java ${b.java_version})`));
            
            const matrix = { include: builds };
            core.setOutput('matrix', JSON.stringify(matrix));
            core.setOutput('repo_count', builds.length);

      - name: Display matrix
        run: |
          echo "## ðŸ“‹ Build Matrix" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo '${{ steps.create-matrix.outputs.matrix }}' | jq '.' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total repositories: ${{ steps.create-matrix.outputs.repo_count }}**" >> $GITHUB_STEP_SUMMARY

  # Build each repository in parallel
  build:
    name: ðŸ”¨ Build ${{ matrix.repository }}
    needs: setup-matrix
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 60
    
    strategy:
      fail-fast: ${{ inputs.fail_fast }}
      max-parallel: ${{ fromJson(inputs.max_parallel) }}
      matrix: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}
    
    outputs:
      build_status: ${{ steps.build.outcome }}
    
    steps:
      - name: ðŸ§¹ Clean workspace
        run: rm -rf ${{ github.workspace }}/* || true
        shell: bash

      - name: ðŸ“¥ Checkout ${{ matrix.repository }}
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repository }}
          ref: ${{ matrix.ref || '' }}
          token: ${{ secrets.REPO_ACCESS_TOKEN || github.token }}
          fetch-depth: 0
          submodules: recursive

      - name: ðŸ” Detect Gradle configuration
        id: detect
        shell: bash
        run: |
          WORK_DIR="${{ matrix.subproject }}"
          WORK_DIR="${WORK_DIR:-.}"
          echo "work_dir=$WORK_DIR" >> $GITHUB_OUTPUT
          
          echo "ðŸ“‚ Repository: ${{ matrix.repository }}"
          echo "ðŸ“ Working directory: $WORK_DIR"
          
          # Detect wrapper
          if [ -f "$WORK_DIR/gradlew" ] || [ -f "$WORK_DIR/gradlew.bat" ]; then
            echo "has_wrapper=true" >> $GITHUB_OUTPUT
            chmod +x "$WORK_DIR/gradlew" 2>/dev/null || true
            echo "âœ… Gradle Wrapper found"
          else
            echo "has_wrapper=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No wrapper, using system Gradle"
          fi
          
          # Detect build file type
          if [ -f "$WORK_DIR/build.gradle.kts" ]; then
            echo "build_type=kotlin" >> $GITHUB_OUTPUT
            echo "ðŸ“„ Kotlin DSL"
          elif [ -f "$WORK_DIR/build.gradle" ]; then
            echo "build_type=groovy" >> $GITHUB_OUTPUT
            echo "ðŸ“„ Groovy DSL"
          else
            echo "âŒ No build.gradle(.kts) found!"
            find . -name "build.gradle*" -type f 2>/dev/null | head -10
            exit 1
          fi
          
          # Get repo short name for artifacts
          REPO_NAME=$(echo "${{ matrix.repository }}" | tr '/' '-')
          echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT

      - name: â˜• Set up JDK ${{ matrix.java_version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java_version }}
          distribution: ${{ inputs.java_distribution }}
          cache: gradle

      - name: ðŸ˜ Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: wrapper
          cache-read-only: false
          add-job-summary: always
          build-scan-publish: ${{ inputs.enable_build_scan }}
          build-scan-terms-of-use-url: "https://gradle.com/help/legal-terms-of-use"
          build-scan-terms-of-use-agree: "yes"

      - name: ðŸ“¦ Install system Gradle (fallback)
        if: steps.detect.outputs.has_wrapper != 'true'
        shell: bash
        run: |
          if ! command -v gradle &> /dev/null; then
            if [[ "$RUNNER_OS" == "Linux" ]]; then
              sudo apt-get update && sudo apt-get install -y gradle
            elif [[ "$RUNNER_OS" == "macOS" ]]; then
              brew install gradle
            elif [[ "$RUNNER_OS" == "Windows" ]]; then
              choco install gradle -y
            fi
          fi

      - name: ðŸ”¨ Build with Gradle
        id: build
        working-directory: ${{ steps.detect.outputs.work_dir }}
        shell: bash
        run: |
          if [ "${{ steps.detect.outputs.has_wrapper }}" == "true" ]; then
            GRADLE_CMD="./gradlew"
            [[ "$RUNNER_OS" == "Windows" ]] && GRADLE_CMD="./gradlew.bat"
          else
            GRADLE_CMD="gradle"
          fi
          
          echo "ðŸš€ Building ${{ matrix.repository }}"
          echo "ðŸ“‹ Tasks: ${{ matrix.gradle_tasks }}"
          echo "â˜• Java: ${{ matrix.java_version }}"
          echo "================================================"
          
          $GRADLE_CMD ${{ matrix.gradle_tasks }} ${{ matrix.gradle_args }} \
            --info \
            --stacktrace \
            -Dorg.gradle.jvmargs="-Xmx4g -XX:+HeapDumpOnOutOfMemoryError"

      - name: ðŸ“¦ Upload artifacts
        if: inputs.upload_artifacts && always()
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ steps.detect.outputs.repo_name }}-java${{ matrix.java_version }}
          path: |
            **/build/libs/*.jar
            **/build/libs/*.war
            **/build/distributions/*
            **/build/outputs/apk/**/*.apk
            **/build/outputs/bundle/**/*.aab
          if-no-files-found: ignore
          retention-days: 14

      - name: ðŸ“Š Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tests-${{ steps.detect.outputs.repo_name }}-java${{ matrix.java_version }}
          path: |
            **/build/reports/tests/**/*
            **/build/test-results/**/*
          if-no-files-found: ignore
          retention-days: 7

      - name: ðŸ“ Job Summary
        if: always()
        shell: bash
        run: |
          STATUS="${{ steps.build.outcome }}"
          ICON="âœ…"
          [ "$STATUS" != "success" ] && ICON="âŒ"
          
          echo "## $ICON ${{ matrix.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Java | ${{ matrix.java_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tasks | \`${{ matrix.gradle_tasks }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Type | ${{ steps.detect.outputs.build_type }} DSL |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | **$STATUS** |" >> $GITHUB_STEP_SUMMARY

  # Summary job
  summary:
    name: ðŸ“Š Build Summary
    needs: [setup-matrix, build]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Generate summary
        uses: actions/github-script@v7
        with:
          script: |
            const matrix = JSON.parse('${{ needs.setup-matrix.outputs.matrix }}');
            const builds = matrix.include || [];
            
            let summary = '## ðŸ“Š Multi-Repository Build Summary\n\n';
            summary += `**Total Repositories:** ${builds.length}\n\n`;
            summary += '| # | Repository | Java | Tasks | Status |\n';
            summary += '|---|------------|------|-------|--------|\n';
            
            builds.forEach((build, i) => {
              // Note: In real scenario, you'd need to fetch actual status
              summary += `| ${i+1} | \`${build.repository}\` | ${build.java_version} | \`${build.gradle_tasks}\` | â³ |\n`;
            });
            
            summary += '\n> Check individual job logs for detailed results.\n';
            
            await core.summary.addRaw(summary).write();
