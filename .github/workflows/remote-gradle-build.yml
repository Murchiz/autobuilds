name: Remote Gradle Builder

on:
  workflow_dispatch:
    inputs:
      repositories:
        description: 'Repos to build (comma-separated: owner/repo or full URL like https://git.example.org/user/repo)'
        required: true
        type: string

      advanced_config:
        description: 'Advanced JSON config (optional)'
        required: false
        type: string
        default: ''

      ref:
        description: 'Branch/tag/SHA'
        required: false
        default: ''
        type: string

      java_version:
        description: 'Java version'
        required: false
        default: '17'
        type: choice
        options: ['8', '11', '17', '21', '25']

      java_distribution:
        description: 'Java distribution'
        required: false
        default: 'temurin'
        type: choice
        options: [temurin, zulu, corretto, liberica, microsoft, oracle]

      gradle_tasks:
        description: 'Gradle tasks (auto-detected for Android if empty)'
        required: false
        default: ''
        type: string

      gradle_args:
        description: 'Additional Gradle arguments'
        required: false
        default: '--no-daemon'
        type: string

      runner_os:
        description: 'Runner OS'
        required: false
        default: 'ubuntu-latest'
        type: choice
        options: [ubuntu-latest, ubuntu-22.04, windows-latest, macos-latest, macos-14]

      max_parallel:
        description: 'Max parallel jobs'
        required: false
        default: '5'
        type: choice
        options: ['1', '2', '3', '5', '10', '20']

      fail_fast:
        description: 'Fail fast on first failure'
        required: false
        default: false
        type: boolean

      upload_artifacts:
        description: 'Upload build artifacts'
        required: false
        default: true
        type: boolean

env:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true"

jobs:
  setup-matrix:
    name: ğŸ“‹ Setup Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.create-matrix.outputs.matrix }}
      repo_count: ${{ steps.create-matrix.outputs.repo_count }}

    steps:
      - name: Create build matrix
        id: create-matrix
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.REPO_ACCESS_TOKEN || github.token }}
          script: |
            const advancedConfig = `${{ inputs.advanced_config }}`.trim();
            const defaultJava = '${{ inputs.java_version }}';
            const defaultTasks = '${{ inputs.gradle_tasks }}';
            const defaultRef = '${{ inputs.ref }}';
            const defaultArgs = '${{ inputs.gradle_args }}';
            const runnerOs = '${{ inputs.runner_os }}';

            // Classify a repo string: full URL â†’ external, github.com URL â†’ normalized owner/repo, bare owner/repo â†’ GitHub
            function classifyRepo(raw) {
              const trimmed = raw.trim();

              // Full GitHub URL â†’ convert to owner/repo so we can use actions/checkout
              const ghUrl = trimmed.match(/^https?:\/\/(?:www\.)?github\.com\/([^\/]+\/[^\/]+?)(?:\.git)?\/?$/i);
              if (ghUrl) {
                return { repository: ghUrl[1], is_external: false };
              }

              // Any other URL (https://, http://, git://, ssh://) or SCP-style git@host:path
              if (/^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//.test(trimmed) || /^git@/.test(trimmed)) {
                return { repository: trimmed, is_external: true };
              }

              // Bare owner/repo â€“ assume GitHub
              return { repository: trimmed, is_external: false };
            }

            let builds = [];

            if (advancedConfig && advancedConfig !== '') {
              try {
                const config = JSON.parse(advancedConfig);
                builds = config.map((item, index) => {
                  const repoRaw = item.repo || item.repository;
                  const { repository, is_external } = classifyRepo(repoRaw);
                  return {
                    index: index + 1,
                    repository,
                    is_external,
                    ref: item.ref || item.branch || defaultRef || '',
                    java_version: String(item.java || item.java_version || defaultJava),
                    gradle_tasks: item.tasks || item.gradle_tasks || defaultTasks,
                    gradle_args: item.args || item.gradle_args || defaultArgs,
                    subproject: item.subproject || item.path || '',
                    runner: item.runner || item.os || runnerOs
                  };
                });
              } catch (e) {
                core.setFailed(`Invalid JSON config: ${e.message}`);
                return;
              }
            } else {
              const repos = `${{ inputs.repositories }}`
                .split(',')
                .map(r => r.trim())
                .filter(r => r.length > 0);

              builds = repos.map((repoRaw, index) => {
                const { repository, is_external } = classifyRepo(repoRaw);
                return {
                  index: index + 1,
                  repository,
                  is_external,
                  ref: defaultRef,
                  java_version: defaultJava,
                  gradle_tasks: defaultTasks,
                  gradle_args: defaultArgs,
                  subproject: '',
                  runner: runnerOs
                };
              });
            }

            if (builds.length === 0) {
              core.setFailed('No repositories specified');
              return;
            }

            const matrix = { include: builds };
            core.setOutput('matrix', JSON.stringify(matrix));
            core.setOutput('repo_count', builds.length);

  build:
    name: ğŸ”¨ Build ${{ matrix.repository }}
    needs: setup-matrix
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 90

    strategy:
      fail-fast: ${{ inputs.fail_fast }}
      max-parallel: ${{ fromJson(inputs.max_parallel) }}
      matrix: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}

    steps:
      # â”€â”€ GitHub-hosted repo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¥ Checkout ${{ matrix.repository }} (GitHub)
        if: ${{ !matrix.is_external }}
        uses: actions/checkout@v6
        with:
          repository: ${{ matrix.repository }}
          ref: ${{ matrix.ref || '' }}
          token: ${{ secrets.REPO_ACCESS_TOKEN || github.token }}
          fetch-depth: 0
          submodules: recursive

      # â”€â”€ External / non-GitHub repo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¥ Clone ${{ matrix.repository }} (External)
        if: ${{ matrix.is_external }}
        shell: bash
        run: |
          set -euo pipefail

          REPO_URL="${{ matrix.repository }}"
          REF="${{ matrix.ref }}"

          echo "ğŸŒ Cloning external repository: $REPO_URL"

          # Clone with full history and recursive submodules
          git clone --recursive "$REPO_URL" .

          # Checkout specific ref/branch/tag if provided
          if [ -n "$REF" ]; then
            echo "ğŸ”€ Checking out ref: $REF"
            git fetch origin "$REF" || true
            git checkout "$REF"
            git submodule update --init --recursive
          fi

          echo "âœ… Clone complete"
          echo "ğŸ“Œ Current commit: $(git log --oneline -1)"

      - name: ğŸ” Detect project type
        id: detect
        shell: bash
        run: |
          WORK_DIR="${{ matrix.subproject }}"
          WORK_DIR="${WORK_DIR:-.}"
          echo "work_dir=$WORK_DIR" >> $GITHUB_OUTPUT

          echo "ğŸ“‚ Repository: ${{ matrix.repository }}"
          echo "ğŸŒ External:   ${{ matrix.is_external }}"
          echo "ğŸ“ Working directory: $WORK_DIR"
          echo ""

          # Detect wrapper
          if [ -f "$WORK_DIR/gradlew" ]; then
            echo "has_wrapper=true" >> $GITHUB_OUTPUT
            chmod +x "$WORK_DIR/gradlew"
            echo "âœ… Gradle Wrapper found"
          else
            echo "has_wrapper=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No wrapper found"
          fi

          # Detect build file type
          if [ -f "$WORK_DIR/build.gradle.kts" ]; then
            echo "build_type=kotlin" >> $GITHUB_OUTPUT
            BUILD_FILE="$WORK_DIR/build.gradle.kts"
          elif [ -f "$WORK_DIR/build.gradle" ]; then
            echo "build_type=groovy" >> $GITHUB_OUTPUT
            BUILD_FILE="$WORK_DIR/build.gradle"
          else
            echo "âŒ No build.gradle(.kts) found!"
            exit 1
          fi

          # ========================================
          # DETECT ANDROID PROJECT
          # ========================================
          IS_ANDROID=false

          if grep -rq "com.android.application\|com.android.library\|android {" "$WORK_DIR" --include="*.gradle*" 2>/dev/null; then
            IS_ANDROID=true
          fi

          if [ -d "$WORK_DIR/app/src/main/AndroidManifest.xml" ] || \
             [ -f "$WORK_DIR/app/src/main/AndroidManifest.xml" ] || \
             find "$WORK_DIR" -name "AndroidManifest.xml" -type f 2>/dev/null | grep -q .; then
            IS_ANDROID=true
          fi

          if [ -f "$WORK_DIR/local.properties" ]; then
            IS_ANDROID=true
          fi

          if [ "$IS_ANDROID" = true ]; then
            echo "is_android=true" >> $GITHUB_OUTPUT
            echo "ğŸ“± Android project detected!"
          else
            echo "is_android=false" >> $GITHUB_OUTPUT
            echo "â˜• Standard Java/Kotlin project"
          fi

          # Determine default tasks
          if [ -z "${{ matrix.gradle_tasks }}" ]; then
            if [ "$IS_ANDROID" = true ]; then
              echo "default_tasks=assembleDebug" >> $GITHUB_OUTPUT
            else
              echo "default_tasks=build" >> $GITHUB_OUTPUT
            fi
          else
            echo "default_tasks=${{ matrix.gradle_tasks }}" >> $GITHUB_OUTPUT
          fi

          # ========================================
          # REPO NAME (safe for artifact naming)
          # ========================================
          REPO="${{ matrix.repository }}"
          if [[ "$REPO" == *"://"* ]]; then
            # Strip protocol, optional trailing .git and slash, replace non-alphanum with -
            REPO_NAME=$(echo "$REPO" | sed 's|^[a-zA-Z]*://||' | sed 's|\.git/*$||' | sed 's|/$||' | tr '/.:@' '-')
          elif [[ "$REPO" == git@* ]]; then
            REPO_NAME=$(echo "$REPO" | sed 's|^git@||' | sed 's|\.git$||' | tr '/:@' '-')
          else
            REPO_NAME=$(echo "$REPO" | tr '/' '-')
          fi
          echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT

      # ========================================
      # ANDROID SDK SETUP
      # ========================================
      - name: ğŸ“± Setup Android SDK
        if: steps.detect.outputs.is_android == 'true'
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 14742923
          log-accepted-android-sdk-licenses: false

      - name: ğŸ“± Accept Android SDK Licenses
        if: steps.detect.outputs.is_android == 'true'
        shell: bash
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true

      - name: â˜• Set up JDK ${{ matrix.java_version }}
        uses: actions/setup-java@v5
        with:
          java-version: ${{ matrix.java_version }}
          distribution: ${{ inputs.java_distribution }}
          cache: gradle

      # ========================================
      # FIX: ADD GOOGLE MAVEN REPOSITORY
      # ========================================
      - name: ğŸ”§ Configure Gradle repositories
        shell: bash
        run: |
          mkdir -p ~/.gradle/init.d

          cat > ~/.gradle/init.d/repo-fix.gradle << 'EOF'
          settingsEvaluated { settings ->
              settings.pluginManagement {
                  repositories {
                      google()
                      mavenCentral()
                      gradlePluginPortal()
                      maven { url 'https://jitpack.io' }
                  }
              }

              settings.dependencyResolutionManagement {
                  repositories {
                      google()
                      mavenCentral()
                      maven { url 'https://jitpack.io' }
                  }
              }
          }

          allprojects {
              repositories {
                  google()
                  mavenCentral()
                  maven { url 'https://jitpack.io' }
              }
          }
          EOF

          cat > ~/.gradle/init.d/repo-fix.gradle.kts << 'EOF'
          settingsEvaluated {
              pluginManagement {
                  repositories {
                      google()
                      mavenCentral()
                      gradlePluginPortal()
                      maven("https://jitpack.io")
                  }
              }
          }

          allprojects {
              repositories {
                  google()
                  mavenCentral()
                  maven("https://jitpack.io")
              }
          }
          EOF

          echo "âœ… Gradle init scripts created"

      - name: ğŸ”§ Create local.properties for Android
        if: steps.detect.outputs.is_android == 'true'
        shell: bash
        working-directory: ${{ steps.detect.outputs.work_dir }}
        run: |
          echo "sdk.dir=$ANDROID_HOME" > local.properties
          echo "âœ… local.properties created with SDK path: $ANDROID_HOME"

      - name: ğŸ˜ Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          gradle-version: wrapper
          cache-read-only: false
          add-job-summary: always

      - name: ğŸ“¦ Install system Gradle (fallback)
        if: steps.detect.outputs.has_wrapper != 'true'
        shell: bash
        run: |
          if ! command -v gradle &> /dev/null; then
            if [[ "$RUNNER_OS" == "Linux" ]]; then
              sudo apt-get update && sudo apt-get install -y gradle
            elif [[ "$RUNNER_OS" == "macOS" ]]; then
              brew install gradle
            fi
          fi

      - name: ğŸ“‹ Show Gradle & project info
        working-directory: ${{ steps.detect.outputs.work_dir }}
        shell: bash
        continue-on-error: true
        run: |
          if [ "${{ steps.detect.outputs.has_wrapper }}" == "true" ]; then
            GRADLE_CMD="./gradlew"
          else
            GRADLE_CMD="gradle"
          fi

          echo "ğŸ“‹ Gradle Version:"
          $GRADLE_CMD --version || true
          echo ""
          echo "ğŸ“‹ Project structure:"
          $GRADLE_CMD projects 2>/dev/null || true

      - name: ğŸ”¨ Build with Gradle
        id: build
        working-directory: ${{ steps.detect.outputs.work_dir }}
        shell: bash
        env:
          ANDROID_HOME: ${{ env.ANDROID_HOME }}
          ANDROID_SDK_ROOT: ${{ env.ANDROID_HOME }}
        run: |
          if [ "${{ steps.detect.outputs.has_wrapper }}" == "true" ]; then
            GRADLE_CMD="./gradlew"
            [[ "$RUNNER_OS" == "Windows" ]] && GRADLE_CMD="./gradlew.bat"
          else
            GRADLE_CMD="gradle"
          fi

          TASKS="${{ steps.detect.outputs.default_tasks }}"

          echo "ğŸš€ Building ${{ matrix.repository }}"
          echo "ğŸŒ External: ${{ matrix.is_external }}"
          echo "ğŸ“‹ Tasks: $TASKS"
          echo "â˜• Java: ${{ matrix.java_version }}"
          echo "ğŸ“± Android: ${{ steps.detect.outputs.is_android }}"
          echo "================================================"

          $GRADLE_CMD $TASKS ${{ matrix.gradle_args }} \
            --info \
            --stacktrace \
            -Dorg.gradle.jvmargs="-Xmx4g -XX:+HeapDumpOnOutOfMemoryError"

      - name: ğŸ“¦ Upload artifacts
        if: inputs.upload_artifacts && always()
        uses: actions/upload-artifact@v6
        with:
          name: build-${{ steps.detect.outputs.repo_name }}-java${{ matrix.java_version }}
          path: |
            **/build/libs/*.jar
            **/build/libs/*.war
            **/build/distributions/*
            **/build/outputs/apk/**/*.apk
            **/build/outputs/bundle/**/*.aab
            **/build/outputs/aar/*.aar
          if-no-files-found: ignore
          retention-days: 14

      - name: ğŸ“Š Upload test reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: tests-${{ steps.detect.outputs.repo_name }}-java${{ matrix.java_version }}
          path: |
            **/build/reports/**/*
            **/build/test-results/**/*
          if-no-files-found: ignore
          retention-days: 7

      - name: ğŸ“ Job Summary
        if: always()
        shell: bash
        run: |
          STATUS="${{ steps.build.outcome }}"
          ICON="âœ…"
          [ "$STATUS" != "success" ] && ICON="âŒ"

          echo "## $ICON ${{ matrix.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Source | ${{ matrix.is_external && 'ğŸŒ External' || 'ğŸ™ GitHub' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Java | ${{ matrix.java_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Android | ${{ steps.detect.outputs.is_android }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tasks | \`${{ steps.detect.outputs.default_tasks }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Type | ${{ steps.detect.outputs.build_type }} DSL |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | **$STATUS** |" >> $GITHUB_STEP_SUMMARY

  summary:
    name: ğŸ“Š Build Summary
    needs: [setup-matrix, build]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Generate summary
        uses: actions/github-script@v8
        with:
          script: |
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });

            const buildJobs = jobs.data.jobs.filter(j => j.name.includes('Build') && !j.name.includes('Summary'));

            let summary = '# ğŸ“Š Build Results\n\n';
            summary += '| Repository | Status | Duration |\n';
            summary += '|------------|--------|----------|\n';

            for (const job of buildJobs) {
              const status = job.conclusion === 'success' ? 'âœ…' :
                            job.conclusion === 'failure' ? 'âŒ' : 'â³';
              const duration = job.completed_at && job.started_at ?
                Math.round((new Date(job.completed_at) - new Date(job.started_at)) / 1000) + 's' : '-';
              const name = job.name.replace('ğŸ”¨ Build ', '');

              summary += `| \`${name}\` | ${status} | ${duration} |\n`;
            }

            await core.summary.addRaw(summary).write();